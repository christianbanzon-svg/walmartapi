services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    restart: unless-stopped

  walmart-api:
    build: .
    image: walmartscraper:latest
    ports:
      - "8001:8000"
    environment:
      - BLUECART_API_KEY=${BLUECART_API_KEY}
      - BLUECART_BASE_URL=${BLUECART_BASE_URL:-https://api.bluecartapi.com/request}
      - WALMART_DOMAIN=${WALMART_DOMAIN:-walmart.com}
      - OUTPUT_DIR=/data/output
      - DATABASE_PATH=${DATABASE_PATH:-/data/walmart.sqlite3}
      - PYTHONPATH=/app
      - REDIS_URL=redis://redis:6379
    volumes:
      - ./walmart/output:/data/output
    depends_on:
      - redis
    command: python walmart/api.py
    restart: unless-stopped

  walmart:
    build: .
    image: walmartscraper:latest
    environment:
      - BLUECART_API_KEY=${BLUECART_API_KEY}
      - BLUECART_BASE_URL=${BLUECART_BASE_URL:-https://api.bluecartapi.com/request}
      - WALMART_DOMAIN=${WALMART_DOMAIN:-walmart.com}
      - OUTPUT_DIR=/data/output
      - DATABASE_PATH=${DATABASE_PATH:-/data/walmart.sqlite3}
      - KEYWORDS=${KEYWORDS:-instyler}
      - MAX_PER_KEYWORD=${MAX_PER_KEYWORD:-10}
      - CATEGORY_ID=${CATEGORY_ID:-}
      - SLEEP=${SLEEP:-0.0}
      - MAX_PAGES=${MAX_PAGES:-50}
      - RETRY_SELLER_PASSES=${RETRY_SELLER_PASSES:-0}
      - RETRY_SELLER_DELAY=${RETRY_SELLER_DELAY:-15.0}
    volumes:
      - ./walmart/output:/data/output
    command:
      - --keywords
      - ${KEYWORDS}
      - --max-per-keyword
      - ${MAX_PER_KEYWORD}
      - --export
      - json
      - csv
      - --max-pages
      - ${MAX_PAGES}
      - --sleep
      - ${SLEEP}
      - --retry-seller-passes
      - ${RETRY_SELLER_PASSES}
      - --retry-seller-delay
      - ${RETRY_SELLER_DELAY}
      - --category-id
      - ${CATEGORY_ID}

volumes:
  redis_data:

